<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HermitClaw Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&family=JetBrains+Mono:wght@400;500&display=swap');

        :root {
            --crab-orange: #ff6b35;
            --shell-gray: #1e293b;
            --ocean-dark: #0f172a;
            --term-green: #10b981;
        }

        body {
            background-color: var(--ocean-dark);
            color: #f8fafc;
            font-family: 'Outfit', sans-serif;
            overflow-x: hidden;
        }

        .mono { font-family: 'JetBrains Mono', monospace; }

        .crab-float { animation: float 6s ease-in-out infinite; }
        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-10px) rotate(2deg); }
        }

        .glass-card {
            background: rgba(30, 41, 59, 0.6);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 107, 53, 0.1);
            transition: all 0.3s ease;
        }

        .glass-card:hover {
            border-color: rgba(255, 107, 53, 0.4);
            box-shadow: 0 10px 30px -10px rgba(255, 107, 53, 0.15);
        }

        .glass-panel {
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(16px);
            border-right: 1px solid rgba(255, 255, 255, 0.05);
        }

        .scanline {
            width: 100%;
            height: 100px;
            z-index: 0;
            background: linear-gradient(0deg, rgba(255,107,53,0) 0%, rgba(255,107,53,0.03) 50%, rgba(255,107,53,0) 100%);
            opacity: 0.1;
            position: fixed;
            bottom: 100%;
            pointer-events: none;
            animation: scanline 8s linear infinite;
        }

        @keyframes scanline {
            0% { bottom: 100%; }
            100% { bottom: -100px; }
        }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--ocean-dark); }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--crab-orange); }

        .terminal-output {
            background-color: #0c0a09;
            background-image: radial-gradient(rgba(30, 41, 59, 0.4) 1px, transparent 0);
            background-size: 20px 20px;
        }
    </style>
</head>
<body class="h-screen flex text-slate-200">

    <div class="scanline"></div>

    <!-- Auth Screen (Login / Setup) -->
    <div id="auth-screen" class="fixed inset-0 z-50 flex items-center justify-center bg-slate-900 p-4">
        <div class="glass-card p-8 rounded-2xl w-full max-w-md shadow-2xl relative overflow-hidden">
            <div class="absolute -top-10 -right-10 opacity-10">
                <svg viewBox="0 0 100 100" class="w-40 h-40 fill-orange-500">
                    <path d="M50 20C30 20 20 35 20 50C20 65 30 80 50 80 80 80C70 65 80 50C80 35 70 20 50 20Z"/>
                </svg>
            </div>

            <div class="mb-8 text-center">
                <div class="w-16 h-16 mx-auto mb-4 rounded-2xl bg-orange-500/20 flex items-center justify-center">
                    <svg viewBox="0 0 100 100" class="w-10 h-10 fill-orange-500">
                        <path d="M50 20C30 20 20 35 20 50C20 65 30 80 50 80C70 80 80 65 80 50C80 35 70 20 50 20Z"/>
                        <path d="M15 30L25 40M10 50L25 50M15 70L25 60M85 30L75 40M90 50L75 50M85 70L75 60" stroke="#ff6b35" stroke-width="5" stroke-linecap="round"/>
                    </svg>
                </div>
                <h1 class="text-3xl font-bold tracking-tight text-white mb-2">HermitClaw</h1>
                <p id="auth-title" class="text-orange-500 font-mono text-sm">SYSTEM_LOCKED</p>
            </div>

            <form id="auth-form" class="space-y-4" onsubmit="handleAuth(event)">
                <div>
                    <label class="block text-xs font-mono text-slate-400 mb-1">OPERATOR_ID</label>
                    <input type="text" id="username" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 focus:border-orange-500 outline-none transition-colors text-white" required autocomplete="off">
                </div>
                <div>
                    <label class="block text-xs font-mono text-slate-400 mb-1">ACCESS_KEY</label>
                    <input type="password" id="password" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 focus:border-orange-500 outline-none transition-colors text-white" required>
                </div>
                
                <div id="auth-error" class="text-red-400 text-xs font-mono hidden text-center"></div>

                <button type="submit" id="auth-btn" class="w-full bg-orange-600 hover:bg-orange-500 text-white py-3 rounded-lg font-bold transition-all shadow-lg shadow-orange-900/20">
                    Authenticate
                </button>
            </form>
        </div>
    </div>

    <!-- Dashboard (Hidden by default) -->
    <div id="dashboard-ui" class="hidden flex w-full h-full">
        <!-- Sidebar -->
        <aside class="w-64 glass-panel flex flex-col z-20 h-full fixed md:relative hidden md:flex">
            <div class="p-6 flex items-center space-x-3 border-b border-white/5">
                <svg viewBox="0 0 100 100" class="w-8 h-8 fill-orange-500 shrink-0">
                    <path d="M50 20C30 20 20 35 20 50C20 65 30 80 50 80C70 80 80 65 80 50C80 35 70 20 50 20ZM35 45C37.7 45 40 47.3 40 50C40 52.7 37.7 55 35 55C32.3 55 30 52.7 30 50C30 47.3 32.3 45 35 45ZM65 45C67.7 45 70 47.3 70 50C70 52.7 67.7 55 65 55C62.3 55 60 52.7 60 50C60 47.3 62.3 45 65 45Z"/>
                    <path d="M15 30L25 40M10 50L25 50M15 70L25 60M85 30L75 40M90 50L75 50M85 70L75 60" stroke="#ff6b35" stroke-width="5" stroke-linecap="round"/>
                </svg>
                <h1 class="font-bold tracking-tight text-lg text-white">HermitClaw</h1>
            </div>

            <nav class="flex-1 p-4 space-y-2">
                <a href="#" class="flex items-center space-x-3 px-4 py-3 bg-orange-500/10 text-orange-400 border border-orange-500/20 rounded-xl">
                    <i data-lucide="layout-grid" class="w-5 h-5"></i>
                    <span class="font-semibold">Agents</span>
                </a>
                <a href="/api/stats" target="_blank" class="flex items-center space-x-3 px-4 py-3 text-slate-400 hover:text-white hover:bg-white/5 rounded-xl transition-colors">
                    <i data-lucide="bar-chart-2" class="w-5 h-5"></i>
                    <span>Metrics</span>
                </a>
                <a href="/api/allowlist" target="_blank" class="flex items-center space-x-3 px-4 py-3 text-slate-400 hover:text-white hover:bg-white/5 rounded-xl transition-colors">
                    <i data-lucide="users" class="w-5 h-5"></i>
                    <span>Allowlist</span>
                </a>
            </nav>

            <div class="p-6">
                <button onclick="logout()" class="w-full flex items-center justify-center gap-2 px-4 py-3 text-slate-400 hover:text-white hover:bg-white/5 rounded-xl transition-colors">
                    <i data-lucide="log-out" class="w-5 h-5"></i>
                    <span>Logout</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col relative z-10 overflow-hidden">
            <!-- Header -->
            <header class="h-20 border-b border-white/5 flex items-center justify-between px-8 bg-slate-900/50 backdrop-blur-sm">
                <div>
                    <h2 class="text-2xl font-bold text-white">Mission Control</h2>
                    <p class="text-xs text-slate-400 mono mt-1">SYSTEM_STATUS: <span class="text-green-400">SECURE</span></p>
                </div>
                
                <div class="flex items-center space-x-4">
                    <button onclick="openModal()" class="bg-orange-600 hover:bg-orange-500 text-white px-5 py-2 rounded-lg font-bold transition-all shadow-lg shadow-orange-900/20 flex items-center gap-2">
                        <i data-lucide="plus-circle" class="w-4 h-4"></i>
                        <span>Spawn Agent</span>
                    </button>
                </div>
            </header>

            <!-- Content Scroll -->
            <div class="flex-1 overflow-y-auto p-8">
                
                <!-- Stats Grid -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-10">
                    <div class="glass-card p-5 rounded-2xl">
                        <div class="flex justify-between items-start mb-4">
                            <div class="p-2 bg-orange-500/10 rounded-lg text-orange-500"><i data-lucide="cpu" class="w-5 h-5"></i></div>
                            <span class="text-xs font-mono text-slate-500">DOCKER</span>
                        </div>
                        <div class="text-2xl font-bold text-white" id="stat-containers">0</div>
                        <div class="text-xs text-slate-400 mt-1">Active Cubicles</div>
                    </div>

                    <div class="glass-card p-5 rounded-2xl">
                        <div class="flex justify-between items-start mb-4">
                            <div class="p-2 bg-blue-500/10 rounded-lg text-blue-500"><i data-lucide="bot" class="w-5 h-5"></i></div>
                            <span class="text-xs font-mono text-slate-500">AGENTS</span>
                        </div>
                        <div class="text-2xl font-bold text-white" id="stat-agents">0</div>
                        <div class="text-xs text-slate-400 mt-1">Registered Identities</div>
                    </div>

                    <div class="glass-card p-5 rounded-2xl">
                        <div class="flex justify-between items-start mb-4">
                            <div class="p-2 bg-green-500/10 rounded-lg text-green-500"><i data-lucide="dollar-sign" class="w-5 h-5"></i></div>
                            <span class="text-xs font-mono text-slate-500">SPEND (24H)</span>
                        </div>
                        <div class="text-2xl font-bold text-white" id="stat-spend">$0.00</div>
                        <div class="text-xs text-slate-400 mt-1">Total Compute Cost</div>
                    </div>

                    <div class="relative glass-card p-5 rounded-2xl overflow-hidden group">
                        <div class="absolute -right-4 -bottom-4 opacity-20 group-hover:opacity-40 transition-opacity">
                             <svg viewBox="0 0 100 100" class="w-24 h-24 fill-orange-500">
                                <path d="M50 20C30 20 20 35 20 50C20 65 30 80 50 80C70 80 80 65 80 50C80 35 70 20 50 20Z" opacity="0.5"/>
                                <path d="M15 30L25 40M85 30L75 40" stroke="#ff6b35" stroke-width="5" stroke-linecap="round"/>
                             </svg>
                        </div>
                        <div class="flex justify-between items-start mb-4">
                            <div class="p-2 bg-purple-500/10 rounded-lg text-purple-500"><i data-lucide="shield" class="w-5 h-5"></i></div>
                            <span class="text-xs font-mono text-slate-500">SECURITY</span>
                        </div>
                        <div class="text-xl font-bold text-white">Secure</div>
                        <div class="text-xs text-slate-400 mt-1">Containers Isolated</div>
                    </div>
                </div>

                <h3 class="text-xl font-bold text-white mb-6 flex items-center gap-2">
                    <i data-lucide="grid" class="w-5 h-5 text-orange-500"></i>
                    Deployed Agents
                </h3>

                <!-- Agent Grid -->
                <div id="agent-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Agents injected by JS -->
                </div>

            </div>
        </main>
    </div>

    <!-- Create Agent Modal -->
    <div id="create-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-slate-900 border border-slate-700 w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden relative">
            <div class="p-6 border-b border-white/10 flex justify-between items-center bg-slate-800/50">
                <h3 class="text-lg font-bold text-white">Initialize New Agent</h3>
                <button onclick="closeModal()" class="text-slate-400 hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-xs font-mono text-slate-400 mb-1">DESIGNATION (NAME)</label>
                    <input type="text" id="new-name" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-white focus:border-orange-500 focus:outline-none transition-colors" placeholder="e.g., Sherlock">
                </div>
                <div>
                    <label class="block text-xs font-mono text-slate-400 mb-1">ROLE DESCRIPTION</label>
                    <input type="text" id="new-role" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-white focus:border-orange-500 focus:outline-none transition-colors" placeholder="e.g., Security Researcher">
                </div>
                <div>
                    <label class="block text-xs font-mono text-slate-400 mb-1">TELEGRAM TOKEN</label>
                    <input type="password" id="new-token" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-white focus:border-orange-500 focus:outline-none transition-colors" placeholder="From @BotFather">
                </div>
                <div>
                    <label class="block text-xs font-mono text-slate-400 mb-1">DOCKER IMAGE</label>
                    <select id="new-image" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-white focus:border-orange-500 focus:outline-none transition-colors">
                        <option value="hermit/base:latest">hermit/base (General Tools)</option>
                        <option value="hermit/python:latest">hermit/python (Data Analysis)</option>
                        <option value="hermit/netsec:latest">hermit/netsec (Security Tools)</option>
                    </select>
                </div>
            </div>
            <div class="p-6 pt-0 flex justify-end">
                <button onclick="createAgent()" class="bg-orange-600 hover:bg-orange-500 text-white px-6 py-2 rounded-lg font-bold transition-all">
                    Deploy to Cubicle
                </button>
            </div>
        </div>
    </div>

    <!-- Terminal/Chat Modal -->
    <div id="terminal-modal" class="fixed inset-0 bg-black/90 backdrop-blur-md z-50 hidden flex items-center justify-center p-4">
        <div class="w-full max-w-4xl h-[80vh] bg-[#0c0a09] border border-slate-700 rounded-xl shadow-2xl flex flex-col overflow-hidden font-mono text-sm relative">
            <!-- Terminal Header -->
            <div class="bg-slate-800 px-4 py-2 flex justify-between items-center border-b border-slate-700">
                <div class="flex items-center gap-2">
                    <div class="w-3 h-3 rounded-full bg-red-500"></div>
                    <div class="w-3 h-3 rounded-full bg-yellow-500"></div>
                    <div class="w-3 h-3 rounded-full bg-green-500"></div>
                    <span id="term-title" class="ml-2 text-slate-400">root@hermitclaw:~</span>
                </div>
                <button onclick="closeTerminal()" class="text-slate-400 hover:text-white"><i data-lucide="x" class="w-4 h-4"></i></button>
            </div>

            <!-- Output Area -->
            <div id="term-output" class="flex-1 p-4 overflow-y-auto terminal-output space-y-2 text-slate-300">
                <div class="text-orange-500">HERMITCLAW v1.0.0 - Secure Shell Connection Established.</div>
                <div class="text-slate-500">Type a command to spawn the agent instance...</div>
            </div>

            <!-- Input Area -->
            <div class="p-4 bg-slate-900 border-t border-slate-800 flex items-center gap-2">
                <span class="text-green-500 font-bold">âžœ</span>
                <input type="text" id="term-input" class="flex-1 bg-transparent border-none focus:ring-0 text-white placeholder-slate-600" placeholder="Send instructions to agent..." autocomplete="off">
                <button onclick="sendTerminalCommand()" class="text-orange-500 hover:text-white"><i data-lucide="send" class="w-5 h-5"></i></button>
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();
        let authState = 'loading';
        let currentAgentId = null;

        async function init() {
            try {
                const res = await fetch('/api/auth/status');
                const data = await res.json();
                
                if (data.status === 'authenticated') {
                    showDashboard();
                } else if (data.status === 'setup_required') {
                    showAuthScreen('INITIALIZE SYSTEM', 'Create Admin Account');
                    authState = 'setup_required';
                } else {
                    showAuthScreen('SYSTEM LOCKED', 'Authenticate');
                    authState = 'login_required';
                }
            } catch (e) {
                console.error("Auth check failed", e);
                showAuthScreen('SYSTEM ERROR', 'Retry');
            }
        }

        function showAuthScreen(title, btnText) {
            document.getElementById('auth-screen').classList.remove('hidden');
            document.getElementById('dashboard-ui').classList.add('hidden');
            document.getElementById('auth-title').innerText = title;
            document.getElementById('auth-btn').innerText = btnText;
        }

        function showDashboard() {
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('dashboard-ui').classList.remove('hidden');
            loadStats();
            loadAgents();
            setInterval(() => { loadStats(); loadAgents(); }, 10000);
        }

        async function handleAuth(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('auth-error');
            errorDiv.classList.add('hidden');

            const endpoint = authState === 'setup_required' ? '/api/auth/setup' : '/api/auth/login';

            try {
                const res = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                
                const data = await res.json();

                if (!res.ok) throw new Error(data.error || 'Operation failed');

                if (authState === 'setup_required') {
                    alert('System Initialized. Please login.');
                    window.location.reload();
                } else {
                    showDashboard();
                }
            } catch (err) {
                errorDiv.innerText = `ERROR: ${err.message}`;
                errorDiv.classList.remove('hidden');
            }
        }

        async function logout() {
            await fetch('/api/auth/logout', { method: 'POST' });
            window.location.reload();
        }

        async function loadStats() {
            try {
                const res = await fetch('/api/stats');
                if(res.status === 401) return logout();
                const data = await res.json();
                document.getElementById('stat-containers').innerText = data.activeContainers;
                document.getElementById('stat-agents').innerText = data.agentsCount;
                document.getElementById('stat-spend').innerText = '$' + data.totalSpendToday.toFixed(4);
            } catch (e) {}
        }

        async function loadAgents() {
            try {
                const res = await fetch('/api/agents');
                if(res.status === 401) return logout();
                const agents = await res.json();
                const grid = document.getElementById('agent-grid');
                grid.innerHTML = '';

                agents.forEach(agent => {
                    const percent = (agent.budget.current_spend_usd / agent.budget.daily_limit_usd) * 100;
                    const color = percent > 90 ? 'bg-red-500' : 'bg-green-500';

                    const card = `
                        <div class="glass-card rounded-2xl p-6 relative group overflow-hidden">
                            <div class="absolute top-0 right-0 p-6 opacity-50 group-hover:opacity-100 transition-opacity">
                                <div class="w-2 h-2 rounded-full ${agent.is_active ? 'bg-green-400 shadow-[0_0_10px_#4ade80]' : 'bg-red-400'}"></div>
                            </div>
                            
                            <div class="mb-4">
                                <div class="w-12 h-12 rounded-xl bg-slate-800 border border-slate-700 flex items-center justify-center mb-3">
                                    <span class="text-2xl">ðŸ¦€</span>
                                </div>
                                <h3 class="text-xl font-bold text-white">${agent.name}</h3>
                                <p class="text-xs text-orange-400 font-mono mt-1">${agent.role}</p>
                            </div>

                            <div class="space-y-3 mb-6">
                                <div class="flex justify-between text-xs text-slate-400 font-mono">
                                    <span>IMAGE</span>
                                    <span>${agent.docker_image.split(':')[0]}</span>
                                </div>
                                <div class="flex justify-between text-xs text-slate-400 font-mono">
                                    <span>BUDGET</span>
                                    <span>$${agent.budget.current_spend_usd.toFixed(4)} / $${agent.budget.daily_limit_usd}</span>
                                </div>
                                <div class="w-full bg-slate-800 h-1.5 rounded-full overflow-hidden">
                                    <div class="${color} h-full" style="width: ${percent}%"></div>
                                </div>
                            </div>

                            <div class="grid grid-cols-2 gap-3">
                                <button onclick="openTerminal(${agent.id}, '${agent.name}')" class="flex items-center justify-center gap-2 bg-slate-800 hover:bg-slate-700 text-white py-2 rounded-lg text-sm font-medium transition-colors border border-slate-700">
                                    <i data-lucide="terminal" class="w-4 h-4"></i> Terminal
                                </button>
                                <button class="flex items-center justify-center gap-2 bg-slate-800 hover:bg-slate-700 text-white py-2 rounded-lg text-sm font-medium transition-colors border border-slate-700">
                                        <i data-lucide="settings" class="w-4 h-4"></i> Config
                                </button>
                            </div>
                        </div>
                    `;
                    grid.innerHTML += card;
                });
                lucide.createIcons();
            } catch(e) {}
        }

        async function createAgent() {
            const name = document.getElementById('new-name').value;
            const role = document.getElementById('new-role').value;
            const token = document.getElementById('new-token').value;
            const image = document.getElementById('new-image').value;

            if(!name || !token) return alert('Name and Token required');

            await fetch('/api/agents', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ name, role, telegram_token: token, docker_image: image })
            });

            closeModal();
            loadAgents();
        }

        function openModal() {
            document.getElementById('create-modal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('create-modal').classList.add('hidden');
        }

        function openTerminal(id, name) {
            currentAgentId = id;
            document.getElementById('term-title').innerText = `ssh ${name.toLowerCase()}@hermitclaw`;
            document.getElementById('terminal-modal').classList.remove('hidden');
            document.getElementById('term-output').innerHTML = `<div class="text-orange-500">Connecting to agent ${name}...</div>`;
        }

        function closeTerminal() {
            document.getElementById('terminal-modal').classList.add('hidden');
            currentAgentId = null;
        }

        async function sendTerminalCommand() {
            const input = document.getElementById('term-input');
            const cmd = input.value;
            if(!cmd || !currentAgentId) return;

            const outputDiv = document.getElementById('term-output');
            outputDiv.innerHTML += `<div class="mt-2"><span class="text-green-500">âžœ</span> <span class="text-white">${cmd}</span></div>`;
            input.value = '';

            outputDiv.innerHTML += `<div class="text-slate-500 animate-pulse">Spawning container...</div>`;
            outputDiv.scrollTop = outputDiv.scrollHeight;

            try {
                const res = await fetch(`/api/test-agent/${currentAgentId}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ message: cmd })
                });
                const data = await res.json();
                
                outputDiv.lastElementChild.remove();

                if(data.error) {
                    outputDiv.innerHTML += `<div class="text-red-500">${data.error}</div>`;
                } else {
                    const cleanOutput = data.output.replace(/\n/g, '<br>');
                    outputDiv.innerHTML += `<div class="text-slate-300 font-mono text-xs mt-1 pl-4 border-l-2 border-slate-700">${cleanOutput}</div>`;
                }
            } catch(e) {
                outputDiv.innerHTML += `<div class="text-red-500">Connection failed: ${e.message}</div>`;
            }

            outputDiv.scrollTop = outputDiv.scrollHeight;
        }

        document.getElementById('term-input').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') sendTerminalCommand();
        });

        init();
    </script>
</body>
</html>
